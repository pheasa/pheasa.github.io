<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart TD Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdn.skypack.dev/octokit"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-pulse-custom { animation: pulse 1.5s infinite; }
        .animate-slide-in { animation: slideIn 0.6s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-400 via-blue-500 to-purple-700 p-5">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <h1 class="text-center text-white text-4xl md:text-5xl font-bold mb-10 bg-gradient-to-r from-pink-400 to-teal-400 bg-clip-text text-transparent drop-shadow-lg">
            Flowchart TD Viewer
        </h1>
        
        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Input Section -->
            <div class="bg-white/15 backdrop-blur-xl border border-white/20 p-8 rounded-3xl shadow-2xl animate-slide-in">
                <h3 class="text-white text-xl font-semibold mb-4">Paste your flowchart TD code:</h3>
                <textarea 
                    id="flowchartInput" 
                    class="w-full h-64 p-5 border-none rounded-2xl font-mono text-sm resize-none bg-white/90 backdrop-blur-md shadow-inner transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-teal-400/40 focus:scale-[1.02]"
                    placeholder="flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E"
                ></textarea>
                
                <div class="mt-5 p-5 bg-teal-400/10 border border-teal-400/30 rounded-2xl backdrop-blur-md">
                    <div class="font-bold mb-3 text-teal-300 text-sm">Example:</div>
                    <div class="font-mono bg-white/10 p-3 rounded-lg text-white/90 border border-white/10 text-xs">
                        flowchart TD<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;A[Start] --> B{Decision}<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;B -->|Yes| C[Action 1]<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;B -->|No| D[Action 2]<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;C --> E[End]<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;D --> E
                    </div>
                </div>
                
                <div id="error-message"></div>
            </div>
            
            <!-- Right: Preview Section -->
            <div class="bg-white/15 backdrop-blur-xl border border-white/20 p-8 rounded-3xl shadow-2xl animate-slide-in relative min-h-96">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <h3 class="text-white text-xl font-semibold">Live Preview:</h3>
                        <span id="render-status" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">
                            Ready
                        </span>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            onclick="maximizePreview()" 
                            title="Maximize"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 border-none text-white rounded-full cursor-pointer text-lg transition-all duration-300 hover:scale-110 backdrop-blur-md"
                        >‚õ∂</button>
                        <button 
                            onclick="clearPreview()" 
                            title="Clear"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 border-none text-white rounded-full cursor-pointer text-lg transition-all duration-300 hover:scale-110 backdrop-blur-md"
                        >üóëÔ∏è</button>
                    </div>
                </div>
                <div id="mermaid-preview" class="text-center mt-5 bg-white/95 p-8 rounded-2xl shadow-xl"></div>
            </div>
        </div>
        
        <!-- Feedback Section -->
        <div class="mt-8 bg-white/15 backdrop-blur-xl border border-white/20 p-8 rounded-3xl shadow-2xl animate-slide-in">
            <h3 class="text-white text-xl font-semibold mb-5">üìù Feedback</h3>
            <div class="feedback-form">
                <div class="flex items-center gap-4 mb-4">
                    <span class="text-white font-medium">Rate this tool:</span>
                    <div class="flex gap-1">
                        <span class="text-2xl cursor-pointer transition-all duration-300 grayscale hover:grayscale-0 hover:scale-125 star" data-rating="1">‚≠ê</span>
                        <span class="text-2xl cursor-pointer transition-all duration-300 grayscale hover:grayscale-0 hover:scale-125 star" data-rating="2">‚≠ê</span>
                        <span class="text-2xl cursor-pointer transition-all duration-300 grayscale hover:grayscale-0 hover:scale-125 star" data-rating="3">‚≠ê</span>
                        <span class="text-2xl cursor-pointer transition-all duration-300 grayscale hover:grayscale-0 hover:scale-125 star" data-rating="4">‚≠ê</span>
                        <span class="text-2xl cursor-pointer transition-all duration-300 grayscale hover:grayscale-0 hover:scale-125 star" data-rating="5">‚≠ê</span>
                    </div>
                </div>
                <textarea 
                    id="feedbackText" 
                    class="w-full h-32 p-4 border-none rounded-2xl font-mono text-sm resize-none bg-white/90 backdrop-blur-md shadow-inner mb-4"
                    placeholder="Share your thoughts, suggestions, or report issues..."
                ></textarea>
                <button 
                    onclick="submitFeedback()" 
                    class="bg-gradient-to-r from-teal-400 to-green-500 hover:from-teal-500 hover:to-green-600 text-white border-none px-8 py-4 rounded-full cursor-pointer text-base font-semibold transition-all duration-300 hover:-translate-y-1 hover:shadow-xl active:-translate-y-0.5 shadow-lg"
                >
                    Send Feedback
                </button>
                <div id="feedback-status" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- Maximize Overlay -->
    <div id="maximize-overlay" class="fixed inset-0 bg-black/95 backdrop-blur-md z-50 hidden items-center justify-center p-5">
        <div class="bg-white rounded-2xl p-5 max-w-[95vw] max-h-[95vh] overflow-auto relative">
            <button 
                onclick="closeMaximize()" 
                class="absolute top-3 right-4 bg-red-500 text-white border-none w-8 h-8 rounded-full cursor-pointer text-base font-bold hover:bg-red-600 transition-colors"
            >√ó</button>
            <div id="maximized-preview"></div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: false });
        
        let selectedRating = 0;
        let renderTimeout;
        
        // Star rating functionality
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                });
            });
            
            // Auto-render on textarea change
            const textarea = document.getElementById('flowchartInput');
            textarea.addEventListener('input', function() {
                clearTimeout(renderTimeout);
                updateRenderStatus('rendering', '‚è≥ Rendering...');
                
                // Debounce rendering by 500ms
                renderTimeout = setTimeout(() => {
                    renderFlowchart();
                }, 500);
            });
            
            // Initial render if there's content
            if (textarea.value.trim()) {
                renderFlowchart();
            }
        });
        
        function updateRenderStatus(type, message) {
            const statusEl = document.getElementById('render-status');
            statusEl.className = 'px-3 py-1 text-sm font-medium rounded-full border';
            
            if (type === 'rendering') {
                statusEl.className += ' bg-yellow-400/20 text-yellow-400 border-yellow-400/30 animate-pulse-custom';
            } else if (type === 'success') {
                statusEl.className += ' bg-green-400/20 text-green-400 border-green-400/30';
            } else {
                statusEl.className += ' bg-gray-500/20 text-gray-400 border-gray-500/30';
            }
            
            statusEl.textContent = message;
        }
        
        function updateStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.remove('grayscale');
                    star.classList.add('scale-125');
                } else {
                    star.classList.add('grayscale');
                    star.classList.remove('scale-125');
                }
            });
        }
        
        function maximizePreview() {
            const preview = document.getElementById('mermaid-preview');
            const maximized = document.getElementById('maximized-preview');
            const overlay = document.getElementById('maximize-overlay');
            
            maximized.innerHTML = preview.innerHTML;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMaximize() {
            const overlay = document.getElementById('maximize-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
        
        function clearPreview() {
            document.getElementById('mermaid-preview').innerHTML = '';
            document.getElementById('flowchartInput').value = '';
            updateRenderStatus('idle', 'Ready');
        }
        
        async function renderFlowchart() {
            const input = document.getElementById('flowchartInput').value.trim();
            const errorDiv = document.getElementById('error-message');
            const previewDiv = document.getElementById('mermaid-preview');
            
            // Clear previous content
            if (errorDiv) errorDiv.innerHTML = '';
            
            if (!input) {
                previewDiv.innerHTML = '<div class="text-center text-white/60 p-10">Enter flowchart code to see live preview</div>';
                updateRenderStatus('idle', 'Ready');
                return;
            }
            
            try {
                // Create unique ID for the diagram
                const diagramId = 'mermaid-' + Date.now();
                
                // Render the mermaid diagram
                const {svg} = await mermaid.render(diagramId, input);
                previewDiv.innerHTML = svg;
                updateRenderStatus('success', '‚úÖ Rendered');
                
                // Auto-hide success status after 2 seconds
                setTimeout(() => {
                    updateRenderStatus('idle', 'Ready');
                }, 2000);
                
            } catch (error) {
                console.error('Render error:', error);
                previewDiv.innerHTML = `<div class="text-red-400 p-5 text-center border border-red-400/30 rounded-lg bg-red-400/10">
                    <strong>Syntax Error:</strong><br>
                    ${error.message || 'Invalid flowchart syntax'}
                </div>`;
                updateRenderStatus('idle', '‚ùå Error');
            }
        }
        
        async function submitFeedback() {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            const statusDiv = document.getElementById('feedback-status');
            
            if (!feedbackText && selectedRating === 0) {
                statusDiv.innerHTML = '<div class="p-3 bg-red-400/20 text-red-400 border border-red-400/30 rounded-lg">Please provide a rating or feedback message</div>';
                return;
            }
            
            // Get current repository info from GitHub Pages URL or set manually
            const currentUrl = window.location.href;
            let owner, repo;
            
            // Auto-detect from GitHub Pages URL (username.github.io/repo-name)
            if (currentUrl.includes('.github.io')) {
                const urlParts = currentUrl.split('/');
                owner = urlParts[2].split('.')[0]; // Extract username from subdomain
                repo = urlParts[3] || owner; // Repo name or default to username
            } else {
                // Manual configuration - replace these
                owner = 'your-username';
                repo = 'your-repo-name';
            }
            
            // Initialize Octokit without token (for same repo, uses current user's permissions)
            const octokit = new Octokit();
            
            // Create issue data
            const issueTitle = `Feedback ${new Date().toISOString().split('T')[0]} - ${selectedRating ? selectedRating + '/5 ‚≠ê' : 'General'}`;
            const issueBody = `
## User Feedback

**Rating:** ${selectedRating}/5 ${selectedRating ? '‚≠ê'.repeat(selectedRating) : 'No rating'}

**Message:**
${feedbackText}

---
**Tool:** Flowchart TD Viewer  
**Timestamp:** ${new Date().toLocaleString()}  
**Browser:** ${navigator.userAgent.split(' ').pop()}  
**URL:** ${window.location.href}
            `.trim();
            
            statusDiv.innerHTML = '<div class="p-3 bg-blue-400/20 text-blue-400 border border-blue-400/30 rounded-lg">üì§ Submitting feedback...</div>';
            
            try {
                // Create issue using Octokit
                const response = await octokit.request('POST /repos/{owner}/{repo}/issues', {
                    owner: owner,
                    repo: repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ['feedback', 
                            selectedRating >= 4 ? 'positive' : 
                            selectedRating <= 2 ? 'needs-improvement' : 
                            'neutral'],
                    headers: {
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                
                statusDiv.innerHTML = `<div class="p-3 bg-green-400/20 text-green-400 border border-green-400/30 rounded-lg">‚úÖ Feedback submitted successfully! 
                    <br><a href="${response.data.html_url}" target="_blank" class="text-green-400 underline">
                    üìã View Issue #${response.data.number}</a></div>`;
                    
                // Clear form
                document.getElementById('feedbackText').value = '';
                selectedRating = 0;
                updateStars();
                
                // Auto-hide success message after 5 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
                
            } catch (error) {
                console.error('Error creating issue:', error);
                
                // Fallback: Direct GitHub issue creation URL
                const title = encodeURIComponent(issueTitle);
                const body = encodeURIComponent(issueBody);
                const labels = selectedRating >= 4 ? 'positive' : selectedRating <= 2 ? 'needs-improvement' : 'neutral';
                const url = `https://github.com/${owner}/${repo}/issues/new?title=${title}&body=${body}&labels=feedback,${labels}`;
                
                window.open(url, '_blank');
                statusDiv.innerHTML = '<div class="p-3 bg-green-400/20 text-green-400 border border-green-400/30 rounded-lg">üåê GitHub opened - please submit your feedback manually!<br><small>Note: You need to be logged in to GitHub</small></div>';
            }
        }
    </script>
</body>
</html>